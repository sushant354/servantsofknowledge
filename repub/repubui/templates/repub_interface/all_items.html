{% extends 'base.html' %}

{% block title %}All Items - REPUB{% endblock %}

{% block extra_head %}
<style>
.clickable-card {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
.clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.item-thumbnail {
    transition: transform 0.2s;
    cursor: pointer;
}
.item-thumbnail:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>All Derived Items</h1>
        <p class="text-muted">Browse all derived items from completed processing jobs</p>
    </div>
    <div class="col-auto">
        <a href="{% url 'home' %}" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> Back to Home
        </a>
    </div>
</div>

<!-- Search Panel -->
<div class="card shadow mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-search"></i> Search Items</h5>
    </div>
    <div class="card-body">
        <form method="get" action="{% url 'all_items' %}">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="search-identifier" class="form-label">Identifier (exact match)</label>
                    <input type="text"
                           class="form-control"
                           id="search-identifier"
                           name="identifier"
                           value="{{ search_identifier }}"
                           placeholder="Enter exact identifier...">
                </div>
                <div class="col-md-4">
                    <label for="search-identifier-prefix" class="form-label">Identifier Prefix</label>
                    <input type="text"
                           class="form-control"
                           id="search-identifier-prefix"
                           name="identifier_prefix"
                           value="{{ search_identifier_prefix }}"
                           placeholder="Enter identifier prefix...">
                </div>
                <div class="col-md-4">
                    <label for="search-author" class="form-label">Author</label>
                    <input type="text"
                           class="form-control"
                           id="search-author"
                           name="author"
                           value="{{ search_author }}"
                           placeholder="Search by author...">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Search
                    </button>
                    {% if has_search %}
                    <a href="{% url 'all_items' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> Clear
                    </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Items List -->
<div class="card shadow">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Derived Items <span class="badge bg-primary">{{ total_items }}</span></h5>
        {% if items %}
        <button type="button" class="btn btn-success btn-sm" id="export-csv-btn" disabled>
            <i class="bi bi-download"></i> Export As CSV (<span id="selected-count">0</span>)
        </button>
        {% endif %}
    </div>
    <div class="card-body p-0">
        {% if items %}
            <form id="export-form" method="post" action="{% url 'export_items_csv' %}">
                {% csrf_token %}
                <input type="hidden" name="identifiers" id="identifiers-input">
            </form>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" class="form-check-input" id="select-all" title="Select all">
                            </th>
                            <th style="width: 140px;">Preview</th>
                            <th>Identifier</th>
                            <th>Author</th>
                            {% if user.is_staff %}<th>Owner</th>{% endif %}
                            <th>Files</th>
                            <th>Size</th>
                            <th>Last Modified</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input item-checkbox" value="{{ item.identifier }}">
                            </td>
                            <td class="text-center">
                                {% if item.thumbnail_url %}
                                    <a href="{% url 'item_directory' item.identifier %}">
                                        <img src="{{ item.thumbnail_url }}"
                                             alt="{{ item.identifier }}"
                                             class="img-thumbnail item-thumbnail"
                                             style="max-width: 120px; max-height: 120px; object-fit: cover;"
                                             title="Click to view item details">
                                    </a>
                                {% else %}
                                    <div class="text-muted" style="font-size: 3rem;">
                                        <i class="bi bi-box-seam"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div>
                                        <strong>{{ item.identifier }}</strong>
                                        <small class="d-block text-muted">
                                            <i class="bi bi-folder"></i> Derived Item
                                        </small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if item.author %}
                                    <span><i class="bi bi-pencil"></i> {{ item.author }}</span>
                                {% else %}
                                    <span class="text-muted">â€”</span>
                                {% endif %}
                            </td>
                            {% if user.is_staff %}
                            <td>
                                {% if item.owner %}
                                    <div class="text-muted">
                                        <i class="bi bi-person"></i> {{ item.owner.username }}
                                        {% if item.owner.first_name %}
                                            <small class="d-block">{{ item.owner.first_name }} {{ item.owner.last_name }}</small>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">Unknown</span>
                                {% endif %}
                            </td>
                            {% endif %}
                            <td>
                                <span class="badge bg-info text-dark">
                                    <i class="bi bi-file-earmark-fill"></i> {{ item.file_count }} file{{ item.file_count|pluralize }}
                                </span>
                            </td>
                            <td>
                                <span>{{ item.total_size }}</span>
                            </td>
                            <td>
                                {% if item.modified %}
                                    <span title="{{ item.modified }}">{{ item.modified|timesince }} ago</span>
                                    <small class="d-block text-muted">{{ item.modified|date:"M d, Y H:i" }}</small>
                                {% else %}
                                    <span class="text-muted">Unknown</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{% url 'item_directory' item.identifier %}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-folder-open"></i> Browse
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center p-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                {% if has_search %}
                    <h4 class="mt-3">No matching items found</h4>
                    <p class="text-muted">No items match your search criteria. Try adjusting your search terms.</p>
                    <a href="{% url 'all_items' %}" class="btn btn-outline-primary">
                        <i class="bi bi-x-lg"></i> Clear Search
                    </a>
                {% else %}
                    <h4 class="mt-3">No items found</h4>
                    <p class="text-muted">No derived items are available. Complete a processing job and derive it to create items.</p>
                    <a href="{% url 'home' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create a Job
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all');
    const itemCheckboxes = document.querySelectorAll('.item-checkbox');
    const exportBtn = document.getElementById('export-csv-btn');
    const selectedCountSpan = document.getElementById('selected-count');
    const exportForm = document.getElementById('export-form');
    const identifiersInput = document.getElementById('identifiers-input');

    function updateSelectedCount() {
        const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
        const count = checkedBoxes.length;
        selectedCountSpan.textContent = count;
        exportBtn.disabled = count === 0;
    }

    function updateSelectAllState() {
        const allChecked = itemCheckboxes.length > 0 &&
            document.querySelectorAll('.item-checkbox:checked').length === itemCheckboxes.length;
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = !allChecked &&
            document.querySelectorAll('.item-checkbox:checked').length > 0;
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
    }

    itemCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectAllState();
            updateSelectedCount();
        });
    });

    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
            const identifiers = Array.from(checkedBoxes).map(cb => cb.value);
            identifiersInput.value = identifiers.join(',');
            exportForm.submit();
        });
    }
});
</script>
{% endblock %}
